// Fill out your copyright notice in the Description page of Project Settings.

#pragma once

#include "CoreMinimal.h"
#include "UObject/NoExportTypes.h"
#include "MD2Asset.generated.h"

#define MAX_MD2_TRIANGLES (4096)
#define MAX_MD2_VERTICES  (2048)
#define MAX_MD2_TEX_COORD (2048)
#define MAX_MD2_FRAMES     (512)
#define MAX_MD2_SKINS       (32)

#define MODEL_IDENT      (844121161)
#define MODEL_VERSION    (8)
#define PRECAL_NORM 162

// This loads the Quake II model format.
// This information taken from the glorious site: http://tfc.duke.free.fr/coding/md2-specs-en.html

static float normal_lookup[PRECAL_NORM][3] =
{
   { -0.525731f, 0.000000f, 0.850651f },
   { -0.442863f, 0.238856f, 0.864188f },
   { -0.295242f, 0.000000f, 0.955423f },
   { -0.309017f, 0.500000f, 0.809017f },
   { -0.162460f, 0.262866f, 0.951056f },
   { 0.000000f, 0.000000f, 1.000000f },
   { 0.000000f, 0.850651f, 0.525731f },
   { -0.147621f, 0.716567f, 0.681718f },
   { 0.147621f, 0.716567f, 0.681718f },
   { 0.000000f, 0.525731f, 0.850651f },
   { 0.309017f, 0.500000f, 0.809017f },
   { 0.525731f, 0.000000f, 0.850651f },
   { 0.295242f, 0.000000f, 0.955423f },
   { 0.442863f, 0.238856f, 0.864188f },
   { 0.162460f, 0.262866f, 0.951056f },
   { -0.681718f, 0.147621f, 0.716567f },
   { -0.809017f, 0.309017f, 0.500000f },
   { -0.587785f, 0.425325f, 0.688191f },
   { -0.850651f, 0.525731f, 0.000000f },
   { -0.864188f, 0.442863f, 0.238856f },
   { -0.716567f, 0.681718f, 0.147621f },
   { -0.688191f, 0.587785f, 0.425325f },
   { -0.500000f, 0.809017f, 0.309017f },
   { -0.238856f, 0.864188f, 0.442863f },
   { -0.425325f, 0.688191f, 0.587785f },
   { -0.716567f, 0.681718f, -0.147621f },
   { -0.500000f, 0.809017f, -0.309017f },
   { -0.525731f, 0.850651f, 0.000000f },
   { 0.000000f, 0.850651f, -0.525731f },
   { -0.238856f, 0.864188f, -0.442863f },
   { 0.000000f, 0.955423f, -0.295242f },
   { -0.262866f, 0.951056f, -0.162460f },
   { 0.000000f, 1.000000f, 0.000000f },
   { 0.000000f, 0.955423f, 0.295242f },
   { -0.262866f, 0.951056f, 0.162460f },
   { 0.238856f, 0.864188f, 0.442863f },
   { 0.262866f, 0.951056f, 0.162460f },
   { 0.500000f, 0.809017f, 0.309017f },
   { 0.238856f, 0.864188f, -0.442863f },
   { 0.262866f, 0.951056f, -0.162460f },
   { 0.500000f, 0.809017f, -0.309017f },
   { 0.850651f, 0.525731f, 0.000000f },
   { 0.716567f, 0.681718f, 0.147621f },
   { 0.716567f, 0.681718f, -0.147621f },
   { 0.525731f, 0.850651f, 0.000000f },
   { 0.425325f, 0.688191f, 0.587785f },
   { 0.864188f, 0.442863f, 0.238856f },
   { 0.688191f, 0.587785f, 0.425325f },
   { 0.809017f, 0.309017f, 0.500000f },
   { 0.681718f, 0.147621f, 0.716567f },
   { 0.587785f, 0.425325f, 0.688191f },
   { 0.955423f, 0.295242f, 0.000000f },
   { 1.000000f, 0.000000f, 0.000000f },
   { 0.951056f, 0.162460f, 0.262866f },
   { 0.850651f, -0.525731f, 0.000000f },
   { 0.955423f, -0.295242f, 0.000000f },
   { 0.864188f, -0.442863f, 0.238856f },
   { 0.951056f, -0.162460f, 0.262866f },
   { 0.809017f, -0.309017f, 0.500000f },
   { 0.681718f, -0.147621f, 0.716567f },
   { 0.850651f, 0.000000f, 0.525731f },
   { 0.864188f, 0.442863f, -0.238856f },
   { 0.809017f, 0.309017f, -0.500000f },
   { 0.951056f, 0.162460f, -0.262866f },
   { 0.525731f, 0.000000f, -0.850651f },
   { 0.681718f, 0.147621f, -0.716567f },
   { 0.681718f, -0.147621f, -0.716567f },
   { 0.850651f, 0.000000f, -0.525731f },
   { 0.809017f, -0.309017f, -0.500000f },
   { 0.864188f, -0.442863f, -0.238856f },
   { 0.951056f, -0.162460f, -0.262866f },
   { 0.147621f, 0.716567f, -0.681718f },
   { 0.309017f, 0.500000f, -0.809017f },
   { 0.425325f, 0.688191f, -0.587785f },
   { 0.442863f, 0.238856f, -0.864188f },
   { 0.587785f, 0.425325f, -0.688191f },
   { 0.688191f, 0.587785f, -0.425325f },
   { -0.147621f, 0.716567f, -0.681718f },
   { -0.309017f, 0.500000f, -0.809017f },
   { 0.000000f, 0.525731f, -0.850651f },
   { -0.525731f, 0.000000f, -0.850651f },
   { -0.442863f, 0.238856f, -0.864188f },
   { -0.295242f, 0.000000f, -0.955423f },
   { -0.162460f, 0.262866f, -0.951056f },
   { 0.000000f, 0.000000f, -1.000000f },
   { 0.295242f, 0.000000f, -0.955423f },
   { 0.162460f, 0.262866f, -0.951056f },
   { -0.442863f, -0.238856f, -0.864188f },
   { -0.309017f, -0.500000f, -0.809017f },
   { -0.162460f, -0.262866f, -0.951056f },
   { 0.000000f, -0.850651f, -0.525731f },
   { -0.147621f, -0.716567f, -0.681718f },
   { 0.147621f, -0.716567f, -0.681718f },
   { 0.000000f, -0.525731f, -0.850651f },
   { 0.309017f, -0.500000f, -0.809017f },
   { 0.442863f, -0.238856f, -0.864188f },
   { 0.162460f, -0.262866f, -0.951056f },
   { 0.238856f, -0.864188f, -0.442863f },
   { 0.500000f, -0.809017f, -0.309017f },
   { 0.425325f, -0.688191f, -0.587785f },
   { 0.716567f, -0.681718f, -0.147621f },
   { 0.688191f, -0.587785f, -0.425325f },
   { 0.587785f, -0.425325f, -0.688191f },
   { 0.000000f, -0.955423f, -0.295242f },
   { 0.000000f, -1.000000f, 0.000000f },
   { 0.262866f, -0.951056f, -0.162460f },
   { 0.000000f, -0.850651f, 0.525731f },
   { 0.000000f, -0.955423f, 0.295242f },
   { 0.238856f, -0.864188f, 0.442863f },
   { 0.262866f, -0.951056f, 0.162460f },
   { 0.500000f, -0.809017f, 0.309017f },
   { 0.716567f, -0.681718f, 0.147621f },
   { 0.525731f, -0.850651f, 0.000000f },
   { -0.238856f, -0.864188f, -0.442863f },
   { -0.500000f, -0.809017f, -0.309017f },
   { -0.262866f, -0.951056f, -0.162460f },
   { -0.850651f, -0.525731f, 0.000000f },
   { -0.716567f, -0.681718f, -0.147621f },
   { -0.716567f, -0.681718f, 0.147621f },
   { -0.525731f, -0.850651f, 0.000000f },
   { -0.500000f, -0.809017f, 0.309017f },
   { -0.238856f, -0.864188f, 0.442863f },
   { -0.262866f, -0.951056f, 0.162460f },
   { -0.864188f, -0.442863f, 0.238856f },
   { -0.809017f, -0.309017f, 0.500000f },
   { -0.688191f, -0.587785f, 0.425325f },
   { -0.681718f, -0.147621f, 0.716567f },
   { -0.442863f, -0.238856f, 0.864188f },
   { -0.587785f, -0.425325f, 0.688191f },
   { -0.309017f, -0.500000f, 0.809017f },
   { -0.147621f, -0.716567f, 0.681718f },
   { -0.425325f, -0.688191f, 0.587785f },
   { -0.162460f, -0.262866f, 0.951056f },
   { 0.442863f, -0.238856f, 0.864188f },
   { 0.162460f, -0.262866f, 0.951056f },
   { 0.309017f, -0.500000f, 0.809017f },
   { 0.147621f, -0.716567f, 0.681718f },
   { 0.000000f, -0.525731f, 0.850651f },
   { 0.425325f, -0.688191f, 0.587785f },
   { 0.587785f, -0.425325f, 0.688191f },
   { 0.688191f, -0.587785f, 0.425325f },
   { -0.955423f, 0.295242f, 0.000000f },
   { -0.951056f, 0.162460f, 0.262866f },
   { -1.000000f, 0.000000f, 0.000000f },
   { -0.850651f, 0.000000f, 0.525731f },
   { -0.955423f, -0.295242f, 0.000000f },
   { -0.951056f, -0.162460f, 0.262866f },
   { -0.864188f, 0.442863f, -0.238856f },
   { -0.951056f, 0.162460f, -0.262866f },
   { -0.809017f, 0.309017f, -0.500000f },
   { -0.864188f, -0.442863f, -0.238856f },
   { -0.951056f, -0.162460f, -0.262866f },
   { -0.809017f, -0.309017f, -0.500000f },
   { -0.681718f, 0.147621f, -0.716567f },
   { -0.681718f, -0.147621f, -0.716567f },
   { -0.850651f, 0.000000f, -0.525731f },
   { -0.688191f, 0.587785f, -0.425325f },
   { -0.587785f, 0.425325f, -0.688191f },
   { -0.425325f, 0.688191f, -0.587785f },
   { -0.425325f, -0.688191f, -0.587785f },
   { -0.587785f, -0.425325f, -0.688191f },
   { -0.688191f, -0.587785f, -0.425325f }
};

struct md2_header_t
{
    int ident;          /* magic number: "IDP2" */
    int version;        /* version: must be 8 */

    int skinwidth;      /* texture width */
    int skinheight;     /* texture height */

    int framesize;      /* size in bytes of a frame */

    int num_skins;      /* number of skins */
    int num_vertices;   /* number of vertices per frame */
    int num_st;         /* number of texture coordinates */
    int num_tris;       /* number of triangles */
    int num_glcmds;     /* number of opengl commands */
    int num_frames;     /* number of frames */

    int offset_skins;   /* offset skin data */
    int offset_st;      /* offset texture coordinate data */
    int offset_tris;    /* offset triangle data */
    int offset_frames;  /* offset frame data */
    int offset_glcmds;  /* offset OpenGL command data */
    int offset_end;     /* offset end of file */

};

/* vector */
typedef float vec3_t[3];

/* texture name */
struct md2_skin_t
{
    char name[64];   /* texture file name */

};

/* texture coords */
struct md2_texCoord_t
{
    short s;
    short t;

};

/* triangle data */
struct md2_triangle_t
{
    unsigned short vertex[3];   /* vertex indices of the triangle */
    unsigned short st[3];       /* tex. coord. indices */

};

/* vertex data */
struct md2_vertex_t
{
    unsigned char v[3];         /* position */
    unsigned char normalIndex;  /* normal vector index */

};

/* frame data */
struct md2_frame_t
{
    vec3_t          scale;      /* scale factor */
    vec3_t          translate;  /* translation vector */
    char            name[16];   /* frame name */
    md2_vertex_t* verts;     /* list of frame's vertices */

};

struct md2_skin_data
{
    short** p_tex{ nullptr };
    int      tex_size;
};

/* md2 model structure */
struct  md2_model_t
{
    md2_header_t header;

    md2_skin_t* skins { nullptr };
    md2_texCoord_t* texcoords { nullptr };
    md2_triangle_t* triangles { nullptr };
    md2_frame_t* frames { nullptr };
    int* glcmds { nullptr };

};

/**
 * 
 */
UCLASS()
class MD2IMPORTEREDITOR_API UMD2Asset : public UObject
{
	GENERATED_BODY()
	
public:
	UMD2Asset();
    ~UMD2Asset();

    bool Load(TArray<uint8>* BinaryData);
    void UnLoad(void);

    void Convert(struct FRawMesh& OutRawMesh);

private:

    md2_model_t    m_model;
    md2_skin_data  m_skin_data;

};
